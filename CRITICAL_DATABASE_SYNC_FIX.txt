ğŸ”´ CRITICAL FIX NEEDED - DATABASE SYNC ISSUE

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

PROBLEM:
When user purchases subscription:
âœ… RevenueCat updates
âœ… Local state updates
âŒ Supabase database NEVER updates

Result:
- User logs out â†’ logs back in
- Profile reloads from Supabase (no subscription data)
- Subscription tier reverts to "FREE"
- User loses their purchase access!

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

SOLUTION: Add Supabase update after successful purchase

File: src/screens/main/PricingScreen.tsx
Function: handlePurchase()

After this line (around line 180):
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if (hasEntitlement) {
  // Update local profile
  const newTier = tier.id as 'free' | 'weekly' | 'lifetime';
  if (profile) {
    setProfile({ ...profile, subscription_tier: newTier });
  }
  setCurrentTier(newTier);

ADD THIS NEW CODE:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // CRITICAL: Also update Supabase database
  try {
    const { data: { session } } = await supabase.auth.getSession();
    if (session?.user?.id && profile) {
      const { error: updateError } = await supabase
        .from('profiles')
        .update({
          subscription_tier: newTier,
          subscription_status: 'active'
        })
        .eq('id', session.user.id);
      
      if (updateError) {
        console.error('[Supabase] Failed to update profile:', updateError);
        // Still show success - payment went through even if DB update failed
      } else {
        console.log('[Supabase] âœ… Profile subscription updated');
      }
    }
  } catch (error) {
    console.error('[Supabase] Update error:', error);
  }

COMPLETE CONTEXT (what the code should look like):
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if (hasEntitlement) {
  const newTier = tier.id as 'free' | 'weekly' | 'lifetime';
  
  if (profile) {
    // Update local state
    setProfile({ ...profile, subscription_tier: newTier });
    
    // Update Supabase database
    try {
      const { data: { session } } = await supabase.auth.getSession();
      if (session?.user?.id) {
        const { error } = await supabase
          .from('profiles')
          .update({
            subscription_tier: newTier,
            subscription_status: 'active'
          })
          .eq('id', session.user.id);
        
        if (error) console.error('DB update failed:', error);
      }
    } catch (error) {
      console.error('Supabase error:', error);
    }
  }
  
  setCurrentTier(newTier);
  
  Alert.alert('Success! ğŸ‰', `Welcome to ${tier.name}! Enjoy all the frequencies.`, [
    { text: 'OK', onPress: onDismiss },
  ]);
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

VERIFICATION AFTER FIX:

1. Make sure PricingScreen.tsx imports supabase:
   import { supabase } from '@/lib/supabaseClient';

2. Test the flow:
   - Login as user
   - Go to pricing
   - Purchase weekly
   - Check that:
     âœ… Alert shows "Success"
     âœ… Local state shows "WEEKLY"
     âœ… Console log shows "Profile subscription updated"
     âœ… Supabase dashboard shows subscription_tier = "weekly"

3. Test persistence:
   - Close app completely
   - Reopen app
   - Check Dashboard â†’ subscription status still shows "WEEKLY"
   - Log out â†’ log back in
   - Check Dashboard â†’ subscription status still shows "WEEKLY"

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ALSO DO THIS:

Make sure Supabase profiles table has these columns:
- subscription_tier (text) - default: 'free'
- subscription_status (text) - default: 'inactive'

If missing, add to Supabase via SQL:
ALTER TABLE profiles ADD COLUMN subscription_tier TEXT DEFAULT 'free';
ALTER TABLE profiles ADD COLUMN subscription_status TEXT DEFAULT 'inactive';

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

PRIORITY: DO THIS BEFORE REBUILD

This is the most critical bug. Without it, users lose access
to paid features when they restart the app.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
